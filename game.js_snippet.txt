    // Add elements to lab table
    const flask = document.createElement('div');
    flask.className = 'lab-item flask';
    
    const flaskWrapper = document.createElement('div');
    flaskWrapper.style.position = 'relative';
    flaskWrapper.style.display = 'inline-block';

    const flaskSolid = document.createElement('div');
    flaskSolid.id = 'flask-solid';
    flaskSolid.style.position = 'absolute';
    flaskSolid.style.bottom = '0';
    flaskSolid.style.left = '0';
    flaskSolid.style.width = '0';
    flaskSolid.style.height = '0';
    flaskSolid.style.backgroundColor = 'transparent'; 
    flaskSolid.style.zIndex = '1'; 
    flaskSolid.style.borderRadius = '0'; 
    flaskSolid.style.opacity = '0';
    flaskSolid.style.transition = 'all 2s ease-in-out, width 0s ease-in-out, left 0s ease-in-out'; 
    flaskWrapper.appendChild(flaskSolid);

    const flaskGas = document.createElement('div');
    flaskGas.id = 'flask-gas';
    flaskGas.style.position = 'absolute';
    flaskGas.style.bottom = '60%'; // Positioned to float above/around neck
    flaskGas.style.left = '10%';
    flaskGas.style.width = '80%';
    flaskGas.style.height = '80%';
    flaskGas.style.backgroundColor = 'transparent'; 
    flaskGas.style.zIndex = '1'; 
    flaskGas.style.opacity = '0';
    flaskGas.style.transition = 'all 2s ease-in-out';
    flaskGas.style.mask = 'url(images/gas.png) no-repeat center / contain';
    flaskGas.style.mask = 'url(images/gas.png) no-repeat center / contain';
    flaskGas.style.webkitMaskMode = 'alpha';
    flaskGas.style.maskMode = 'alpha';
    flaskWrapper.appendChild(flaskGas);

    const flaskImage = document.createElement('img');
    flaskImage.src = 'images/flask.png';
    flaskImage.alt = 'Erlenmeyer Flask';
    flaskImage.style.position = 'relative';
    flaskImage.style.zIndex = '2'; 
    flaskWrapper.appendChild(flaskImage);

    flask.appendChild(flaskWrapper);
    labTable.appendChild(flask);

    let selectedBeakers = [];
    let currentTemperature = 298;

    // Ambient temperature adjustment interval (Newton's Law of Cooling)
    window.activeTempInterval = setInterval(() => {
        const ambientTemp = 298;
        const k = 0.002; // Cooling constant
        const diff = currentTemperature - ambientTemp;
        
        if (Math.abs(diff) > 0.01) {
            currentTemperature -= k * diff;
        } else {
            currentTemperature = ambientTemp;
        }
        
        const tempDisplay = document.getElementById('temp-display');
        if (tempDisplay && tempDisplay.innerText !== "") {
            tempDisplay.innerText = "Temperature: " + currentTemperature.toFixed(1) + " K";
        }
    }, 1000);

    const labData = fullJSdata.labs.find(lab => lab.labid === labid);

    for (let i = 1; i <= 4; i++) {
      const beakerContainer = document.createElement('div');
      beakerContainer.className = 'lab-item beaker';
      
      const beakerWrapper = document.createElement('div');
      beakerWrapper.style.position = 'relative';
      beakerWrapper.style.display = 'inline-block';

      const beakerImage = document.createElement('img');
      beakerImage.src = 'images/beaker.png';
      beakerImage.alt = `Beaker ${i}`;
      beakerImage.style.position = 'relative';
      beakerImage.style.zIndex = '2';
      
      // Apply fluid color if available
      const fluidColor = labData ? labData['color' + i] : null;
      if (fluidColor) {
        const fluidDiv = document.createElement('div');
        fluidDiv.style.position = 'absolute';
        fluidDiv.style.bottom = '15%';
        fluidDiv.style.left = '15%';
        fluidDiv.style.width = '70%';
        fluidDiv.style.height = '50%';
        fluidDiv.style.backgroundColor = fluidColor;
        fluidDiv.style.zIndex = '1';
        fluidDiv.style.borderRadius = '0 0 10% 10%';
        beakerWrapper.appendChild(fluidDiv);
      }
      
      beakerWrapper.appendChild(beakerImage);
      beakerContainer.appendChild(beakerWrapper);
      
      const beakerLabel = document.createElement('div');
      if (labData) {
        beakerLabel.innerHTML = labData['beaker' + i] || `Beaker ${i}`;
      } else {
        beakerLabel.innerHTML = `Beaker ${i}`;
      }
      beakerContainer.appendChild(beakerLabel);
      
      const beakerIdx = i;
      beakerContainer.onclick = () => { 
        console.log(`Beaker ${beakerIdx} clicked`); 
        
        selectedBeakers.push(beakerIdx);

        const getSplitColor = (beakerIndices) => {
            const colors = beakerIndices.map(idx => labData['color' + idx]).filter(c => c);
            if (colors.length === 0) return 'white';
            if (colors.length === 1) return colors[0];
            
            let gradientParts = [];
            const step = 100 / colors.length;
            colors.forEach((color, i) => {
                gradientParts.push(`${color} ${i * step}%`);
                gradientParts.push(`${color} ${(i + 1) * step}%`);
            });
            return `linear-gradient(to right, ${gradientParts.join(', ')})`;
        };

        const handleReaction = (outcome, reactionData) => {
            if (outcome) {
                const slowReactionDelay = 1000; // 1 second delay
                setTimeout(() => {
                    let type = null;
                    let color = null;

                    if (typeof outcome === 'string') {
                        if (outcome === 'solid') {
                            type = 'solid';
                            color = reactionData.solidcolor;
                        }
                    } else if (typeof outcome === 'object') {
                         type = outcome.type;
                         color = outcome.color || reactionData.solidcolor;
                    }

                    if (flaskSolid) {
                        if (type === 'solid') {
                            flaskSolid.style.width = '40%';
                            flaskSolid.style.height = '40%';
                            flaskSolid.style.bottom = '10%';
                            flaskSolid.style.left = '30%';
                            flaskSolid.style.borderRadius = '0';
                            flaskSolid.style.clipPath = 'none';
                            flaskSolid.style.backgroundColor = color || 'white';
                            flaskSolid.style.opacity = '1';
                            if (flaskGas) flaskGas.style.opacity = '0';
                        } else if (type === 'liquid') {
                            flaskSolid.style.width = '90%';
                            flaskSolid.style.height = '50%';
                            flaskSolid.style.bottom = '8%';
                            flaskSolid.style.left = '5%';
                            flaskSolid.style.borderRadius = '0 0 10% 10%';
                            flaskSolid.style.clipPath = 'polygon(35% 0%, 65% 0%, 100% 100%, 0% 100%)';
                            flaskSolid.style.backgroundColor = color || 'white';
                            flaskSolid.style.opacity = '1';
                            if (flaskGas) flaskGas.style.opacity = '0';
                        } else if (type === 'gas') {
                            flaskSolid.style.opacity = '0';
                            if (flaskGas) {
                                flaskGas.style.backgroundColor = color || 'white';
                                flaskGas.style.opacity = '1';
                            }
                        }
                    }
                    
                    // Update temperature display if it's currently showing
                    const tempDisplay = document.getElementById('temp-display');
                    
                    // Parse temperature from outcome
                    if (outcome && outcome.temp) {
                        currentTemperature = parseInt(outcome.temp);
                    } else if (typeof outcome === 'string' && outcome === 'solid' && reactionData.temp) {
                        currentTemperature = parseInt(reactionData.temp);
                    }

                    if (tempDisplay && tempDisplay.innerText !== "") {
                        if (outcome || (typeof outcome === 'string' && outcome === 'solid' && reactionData.temp)) {
                            tempDisplay.innerText = "Temperature: " + currentTemperature.toFixed(1) + " K";
                        } else {
                            tempDisplay.innerText = "Temperature: N/A";
                        }
                    }
                }, slowReactionDelay);
            }
        };

        if (selectedBeakers.length === 1) {
            const fluidColor = labData ? labData['color' + beakerIdx] : null;
            if (fluidColor) {
                if (flaskSolid) {
                    flaskSolid.style.width = '90%';
                    flaskSolid.style.height = '50%';
                    flaskSolid.style.bottom = '8%';
                    flaskSolid.style.left = '5%';
                    flaskSolid.style.borderRadius = '0 0 10% 10%';
                    flaskSolid.style.clipPath = 'polygon(35% 0%, 65% 0%, 100% 100%, 0% 100%)';
                    flaskSolid.style.backgroundColor = fluidColor;
                    flaskSolid.style.opacity = '1';
                    if (flaskGas) flaskGas.style.opacity = '0';
                }
            }
        } else if (selectedBeakers.length >= 2 && selectedBeakers.length <= 4) {
             if (labData && labData.reaction) {
                let reactionData = null;
                try {
                    reactionData = (new Function("return " + labData.reaction))();
                } catch (e) {
                    console.error("Error parsing reaction data:", e);
                }
                
                if (reactionData) {
                    const sortedKey = [...selectedBeakers].sort((a, b) => a - b).join("_");
                    let outcome = reactionData[sortedKey];

                    // Fallback for length 2 (checking reverse order for legacy support)
                    if (!outcome && selectedBeakers.length === 2) {
                        const reverseKey = selectedBeakers[1] + "_" + selectedBeakers[0];
                        outcome = reactionData[reverseKey];
                    }
                    
                    if (outcome) {
                        handleReaction(outcome, reactionData);
                    } else {
                        // Split colors if no reaction found
                        const splitColor = getSplitColor(selectedBeakers);
                        if (flaskSolid) {
                            flaskSolid.style.width = '90%';
                            flaskSolid.style.height = '50%';
                            flaskSolid.style.bottom = '8%';
                            flaskSolid.style.left = '5%';
                            flaskSolid.style.borderRadius = '0 0 10% 10%';
                            flaskSolid.style.clipPath = 'polygon(35% 0%, 65% 0%, 100% 100%, 0% 100%)';
                            flaskSolid.style.background = splitColor; 
                            flaskSolid.style.opacity = '1';
                            if (flaskGas) flaskGas.style.opacity = '0';
                        }
                    }
                }
             }
        } else if (selectedBeakers.length === 5) {
          alert("Please reset the flask");
        }
      };
      labTable.appendChild(beakerContainer);
    }